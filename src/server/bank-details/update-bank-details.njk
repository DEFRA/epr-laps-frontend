{% extends 'layouts/page.njk' %}
{% from "govuk/components/input/macro.njk" import govukInput %}
{% from "govuk/components/fieldset/macro.njk" import govukFieldset %}
{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "govuk/components/error-summary/macro.njk" import govukErrorSummary %}
{% set showBackLink = true %}

{% block content %}
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds">

      {# Error summary placeholder at the top #}
      {% if aggregatedErrors.length %}
        {{ govukErrorSummary({
          titleText: translations['there-is'],
          errorList: aggregatedErrors
        }) }}
      {% endif %}

      <form
        id="update-bank-form"
        method="post"
        action="/update-bank-details?lang={{ currentLang }}"
        class="govuk-form-group"
        novalidate
      >
        <fieldset class="govuk-fieldset">
          <legend class="govuk-fieldset__legend govuk-fieldset__legend--xl">
            <span class="govuk-caption-xl">{{ translations['request-to'] }}</span>
            <h1 class="govuk-fieldset__heading">{{ translations['new-bank'] }}</h1>
          </legend>
          <dl class="govuk-body govuk-!-margin-top-4">
            <dt class="govuk-!-margin-bottom-2">{{ translations['requested-by'] }}</dt>
              <dd class="govuk-!-margin-left-0 govuk-!-font-weight-bold govuk-!-margin-bottom-6">{{ authedUser.displayName }}</dd>
            <dt class="govuk-!-margin-bottom-2">{{ translations['local-authority-name'] }}</dt>
              <dd class="govuk-!-margin-left-0 govuk-!-font-weight-bold"> {{ authedUser.organisationName }}</dd>
          </dl>
          {{ govukInput({
            label: { text: translations['account-name'] },
            id: "accountName",
            name: "accountName",
            value: payload.accountName,
            spellcheck: false,
            errorMessage: errors.accountName,
            attributes: { maxlength: "256" }
          }) }}

          {{ govukInput({
            label: { text: translations['sort-code'] },
            hint: { text: translations['must-be'] },
            id: "sortCode",
            name: "sortCode",
            inputmode: "numeric",
            value: payload.sortCode,
            errorMessage: errors.sortCode,
            spellcheck: false,
            classes: "govuk-input--width-5 govuk-input--extra-letter-spacing",
            attributes: { maxlength: "8" },
            autocomplete: "sort-code"
          }) }}

          {{ govukInput({
            label: { text: translations['account-number'] },
            hint: { text: translations['must-be-between'] },
            id: "accountNumber",
            name: "accountNumber",
            inputmode: "numeric",
            value: payload.accountNumber,
            errorMessage: errors.accountNumber,
            spellcheck: false,
            classes: "govuk-input--width-10",
            attributes: { maxlength: "10" },
            autocomplete: "account-number"
          }) }}
        </fieldset>

        <div class="govuk-!-margin-top-6">
          {{ govukButton({
            text: translations['continue'],
            type: "submit"
          }) }}
        </div>
      </form>

    </div>
  </div>

<script>
  document.getElementById('language-switch').addEventListener('click', function() {
    const form = document.getElementById('update-bank-form');
    
    // Save current form values to localStorage
    const payload = {
      accountName: form.accountName.value,
      sortCode: form.sortCode.value,
      accountNumber: form.accountNumber.value
    };
    localStorage.setItem('updateBankPayload', JSON.stringify(payload));

    // Switch language in the URL
    const currentLang = "{{ currentLang }}";
    const newLang = currentLang === 'en' ? 'cy' : 'en';
    const url = new URL(window.location.href);
    url.searchParams.set('lang', newLang);
    window.location.href = url.toString();
  });

  // Restore form values on page load
  document.addEventListener('DOMContentLoaded', function() {
    const savedPayload = JSON.parse(localStorage.getItem('updateBankPayload') || '{}');
    if (savedPayload.accountName) document.getElementById('accountName').value = savedPayload.accountName;
    if (savedPayload.sortCode) document.getElementById('sortCode').value = savedPayload.sortCode;
    if (savedPayload.accountNumber) document.getElementById('accountNumber').value = savedPayload.accountNumber;

    // Clear localStorage after restore
    localStorage.removeItem('updateBankPayload');
  });
</script>
{% endblock %}
