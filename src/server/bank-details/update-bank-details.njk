{% extends 'layouts/page.njk' %}
{% from "govuk/components/input/macro.njk" import govukInput %}
{% from "govuk/components/fieldset/macro.njk" import govukFieldset %}
{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "govuk/components/error-summary/macro.njk" import govukErrorSummary %}
{% set showBackLink = true %}

{% block content %}
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds">

      {# Error summary placeholder at the top #}
      {% if aggregatedErrors.length %}
        {{ govukErrorSummary({
          titleText: translations['there-is'],
          errorList: aggregatedErrors
        }) }}
      {% endif %}

      <form
        id="update-bank-form"
        method="post"
        action="/update-bank-details?lang={{ currentLang }}"
        class="govuk-form-group"
        novalidate
      >
        <fieldset class="govuk-fieldset">
          <legend class="govuk-fieldset__legend govuk-fieldset__legend--xl">
            <span class="govuk-caption-xl">{{ translations['request-to'] }}</span>
            <h1 class="govuk-fieldset__heading">{{ translations['new-bank'] }}</h1>
          </legend>
          <dl class="govuk-body govuk-!-margin-top-4">
            <dt class="govuk-!-margin-bottom-2">{{ translations['requested-by'] }}</dt>
              <dd class="govuk-!-margin-left-0 govuk-!-font-weight-bold govuk-!-margin-bottom-6">{{ authedUser.displayName }}</dd>
            <dt class="govuk-!-margin-bottom-2">{{ translations['local-authority-name'] }}</dt>
              <dd class="govuk-!-margin-left-0 govuk-!-font-weight-bold"> {{ authedUser.organisationName }}</dd>
          </dl>
          <input type="hidden" name="csrfToken" value="{{csrfToken}}">
          {{ govukInput({
            label: { text: translations['account-name'] },
            id: "accountName",
            name: "accountName",
            value: payload.accountName,
            spellcheck: false,
            errorMessage: errors.accountName,
            attributes: { maxlength: "256" }
          }) }}

          {{ govukInput({
            label: { text: translations['sort-code'] },
            hint: { text: translations['must-be'] },
            id: "sortCode",
            name: "sortCode",
            inputmode: "numeric",
            value: payload.sortCode,
            errorMessage: errors.sortCode,
            spellcheck: false,
            classes: "govuk-input--width-5 govuk-input--extra-letter-spacing",
            attributes: { maxlength: "8" }
          }) }}

          {{ govukInput({
            label: { text: translations['account-number'] },
            hint: { text: translations['must-be-between'] },
            id: "accountNumber",
            name: "accountNumber",
            inputmode: "numeric",
            value: payload.accountNumber,
            errorMessage: errors.accountNumber,
            spellcheck: false,
            classes: "govuk-input--width-10",
            attributes: { maxlength: "10" }
          }) }}
        </fieldset>

        <div class="govuk-!-margin-top-6">
          {{ govukButton({
            text: translations['continue'],
            type: "submit"
          }) }}
        </div>
      </form>

    </div>
  </div>

 <script>
document.addEventListener('DOMContentLoaded', function () {
  const form = document.getElementById('update-bank-form');
  if (!form) return;

  let suppressBeforeUnload = false; 

  // check if form has any values 
  const formHasValues = () => {
    return ['accountName', 'sortCode', 'accountNumber'].some(
      field => form[field]?.value && form[field].value.trim() !== ''
    );
  };

  // Track changes in form to mark as dirty 
  const markDirty = () => {
    // Only set dirty if there is any value in fields
    suppressBeforeUnload = false; // reset suppression if user modifies the form
  };
  form.addEventListener('input', markDirty, { passive: true });
  form.addEventListener('change', markDirty, { passive: true });

  // Reset dirty state on submit 
  form.addEventListener('submit', function () {
    suppressBeforeUnload = true; 
  });

  window.addEventListener('beforeunload', function (e) {
    if (suppressBeforeUnload) return;
    if (formHasValues()) { // Only warn if at least one field has a value
      e.preventDefault();
      e.returnValue = '';
      return '';
    }
  });

  document.querySelectorAll('.dwp-language-toggle a').forEach(link => {
    link.addEventListener('click', function (e) {
      e.preventDefault();
      suppressBeforeUnload = true; // skip popup for language toggle

      const hiddenForm = document.createElement('form');
      hiddenForm.method = 'POST';
      hiddenForm.action = '/switch-language';

      ['accountName', 'sortCode', 'accountNumber'].forEach(field => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = field;
        input.value = form[field]?.value || '';
        hiddenForm.appendChild(input);
      });

      const langInput = document.createElement('input');
      langInput.type = 'hidden';
      langInput.name = 'currentLang';
      langInput.value = "{{ currentLang }}";
      hiddenForm.appendChild(langInput);

      const csrfInput = document.createElement('input');
      csrfInput.type = 'hidden';
      csrfInput.name = 'csrfToken';
      csrfInput.value = form.querySelector('[name="csrfToken"]').value || '';
      hiddenForm.appendChild(csrfInput);

      document.body.appendChild(hiddenForm);
      hiddenForm.submit();
    }, { passive: false });
  });
});
</script>

{% endblock %}
